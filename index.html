<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HAHA - Global</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --primary-color: #FFFFFF;
            --accent-green: #4CAF50;
            --accent-red: #F44336;
            --accent-gold: #FFD700;
            --font-head: 'Anton', sans-serif;
            --font-body: 'Inter', sans-serif;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--primary-color);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
        }

        .font-head { font-family: var(--font-head); letter-spacing: 1px; }

        .nav-bar {
            position: fixed; bottom: 0; width: 100%; height: var(--nav-height);
            background: var(--surface-color); display: flex; justify-content: space-around;
            align-items: center; border-top: 1px solid #333; z-index: 1000;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #666; font-size: 24px; cursor: pointer; transition: color 0.2s;
        }
        .nav-item.active { color: var(--primary-color); }
        .nav-label { font-size: 10px; margin-top: 2px; font-family: var(--font-body); }

        .view {
            flex: 1; display: none; position: relative;
            height: calc(100vh - var(--nav-height)); overflow-y: hidden; width: 100%;
        }
        .view.active { display: block; }

        .discovery-header {
            position: absolute; top: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 100; pointer-events: none; 
        }
        .toggle-container {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(5px);
            padding: 4px; border-radius: 20px;
            display: flex; gap: 5px;
            border: 1px solid #333;
            pointer-events: auto; 
        }
        .toggle-btn {
            background: transparent; color: #999; border: none;
            padding: 6px 16px; border-radius: 16px;
            font-size: 13px; font-weight: bold; cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: var(--primary-color); color: #000;
        }

        .meme-layout {
            background: #fff; color: #000;
            display: flex; flex-direction: column;
            overflow: hidden; position: relative;
            width: 100%; height: 100%;
        }
        
        .meme-layout .meme-top {
            flex: 0 0 25%; 
            display: flex; align-items: center; justify-content: center;
            padding: 2% 5%; text-align: center;
            font-family: var(--font-body); font-weight: bold;
            line-height: 1.3; word-break: break-word;
        }

        .meme-layout .meme-middle {
            flex: 1; margin: 0 5%;
            border: 3px solid #000; 
            background: #eee;
            position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .meme-layout .meme-img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        .meme-layout .meme-footer {
            flex: 0 0 15%; 
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 6%;
            background: #fafafa;
            border-top: 1px solid #ccc;
            font-size: 12px; color: #555;
        }
        .meme-layout .meme-watermark { 
            font-family: 'Anton', sans-serif; 
            color: #999; 
            font-size: 16px; letter-spacing: 1px;
            margin-left: auto; 
        }

        #discovery-view.active { display: flex; align-items: center; justify-content: center; }
        
        .card-container {
            position: relative; width: 90%; max-width: 380px; 
            aspect-ratio: 350/480; max-height: 75vh; perspective: 1000px;
            margin-top: 40px; 
        }

        .tinder-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transform-origin: 50% 100%; 
            transition: transform 0.1s linear, opacity 0.3s;
            will-change: transform;
            background: #fff;
        }
        .tinder-card .meme-top { font-size: clamp(18px, 6vw, 28px); }

        .tinder-card.sponsored {
            border: 4px solid var(--accent-gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .sponsored-tag {
            position: absolute; top: 10px; right: 10px;
            background: var(--accent-gold); color: #000;
            font-family: var(--font-head); font-size: 10px;
            padding: 2px 6px; border-radius: 4px; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .empty-card {
            background: #222; border: 2px dashed #444; color: #666;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }

        .stats-container { display: flex; gap: 10px; align-items: center; margin-top: 4px; }
        .stat-item { display: flex; align-items: center; font-size: 13px; color: #555; font-family: var(--font-head); font-weight: bold; }
        .stamp-icon {
            width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 8px; font-weight: bold; text-transform: uppercase; margin-right: 5px; border: 2px solid; background: #fff;
        }
        .stamp-pass { color: var(--accent-red); border-color: var(--accent-red); transform: rotate(-15deg); }
        .stamp-haha { color: var(--accent-green); border-color: var(--accent-green); transform: rotate(15deg); }
        
        .badge {
            position: absolute; top: 40px; padding: 5px 15px; border: 4px solid; border-radius: 8px;
            font-size: 32px; font-weight: bold; font-family: var(--font-head); opacity: 0; z-index: 100; pointer-events: none;
        }
        .badge-haha { right: 20px; color: var(--accent-green); border-color: var(--accent-green); transform: rotate(15deg); }
        .badge-pass { left: 20px; color: var(--accent-red); border-color: var(--accent-red); transform: rotate(-15deg); }

        .share-btn {
            background: transparent; color: #333; border: none; 
            width: 32px; height: 32px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-left: 10px; z-index: 50; 
        }
        .share-btn svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        #ranking-view { overflow-y: auto; }
        .ranking-header {
            padding: 20px; position: sticky; top: 0; background: var(--bg-color);
            z-index: 10; border-bottom: 1px solid #333;
        }
        .filter-group { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn {
            background: #333; color: #fff; border: none; padding: 8px 16px;
            border-radius: 20px; white-space: nowrap; font-size: 12px;
        }
        .filter-btn.active { background: var(--primary-color); color: #000; font-weight: bold; }
        .rank-list { padding: 0 10px 80px 10px; }
        .rank-item {
            display: flex; align-items: center; background: var(--surface-color);
            margin-bottom: 10px; padding: 10px; border-radius: 8px;
        }
        .rank-num { font-family: var(--font-head); font-size: 24px; width: 40px; text-align: center; color: #555; }
        .rank-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px; background: #000; }
        .rank-score { font-family: var(--font-head); color: var(--accent-green); margin-left: auto; }

        .mine-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-bottom: 80px; }
        .mini-card-wrapper {
            background: #fff; border-radius: 4px; overflow: hidden;
            aspect-ratio: 350/480; box-shadow: 0 2px 5px rgba(0,0,0,0.3); position: relative;
        }
        .mini-card-wrapper .meme-top { font-size: 10px; padding: 5px; } 
        .mini-card-wrapper .meme-middle { margin: 0 6px; border-width: 2px; } 
        .mini-card-wrapper .meme-footer { padding: 0 6px; font-size: 8px; }
        .mini-card-wrapper .meme-watermark { font-size: 10px; }
        .mini-card-wrapper .stats-container { gap: 4px; margin-top: 2px; }
        .mini-card-wrapper .stat-item { font-size: 8px; }
        .mini-card-wrapper .stamp-icon { width: 14px; height: 14px; font-size: 4px; border-width: 1px; margin-right: 2px; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000; display: none;
            flex-direction: column;
        }
        .modal.open { display: flex; }
        .modal-header {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333;
        }
        .btn-icon { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .studio-body { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .stage-wrapper { position: relative; width: 100%; max-width: 350px; aspect-ratio: 350/480; box-shadow: 0 0 20px rgba(0,0,0,0.5); margin-bottom: 20px; background: #fff; overflow: hidden; }
        .stage-bg-img { position: absolute; top: 120px; left: 20px; width: calc(100% - 40px); height: calc(100% - 192px); object-fit: cover; background: #eee; z-index: 1; }
        .stage-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10; display: none; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #333; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .studio-controls { width: 100%; max-width: 350px; }
        textarea { width: 100%; height: 80px; background: #333; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-family: var(--font-body); resize: none; }
        .refresh-btn { background: #333; color: #fff; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 15px; }
        .refresh-btn svg { width: 20px; height: 20px; fill: #fff; }

        .action-row { display: flex; gap: 10px; margin-top: 10px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; font-size: 14px; }
        .btn-boost { background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; }
        .btn-normal { background: #333; color: #fff; }

        .help-btn { width: 44px; height: 44px; background: #222; color: #999; border: 1px solid #444; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: var(--font-body); display: flex; justify-content: center; align-items: center; }
        .help-tooltip { position: absolute; bottom: 65px; right: 0; width: 240px; background: #222; border: 1px solid var(--accent-gold); color: #fff; padding: 15px; border-radius: 8px; font-size: 13px; z-index: 200; box-shadow: 0 4px 20px rgba(0,0,0,0.6); display: none; text-align: left; }
        .help-tooltip strong { color: var(--accent-gold); display: block; margin-bottom: 5px; font-size: 14px; }
        .help-list { margin: 0; padding-left: 20px; color: #ccc; line-height: 1.6; }
        .help-list li::marker { color: var(--accent-gold); }

        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--surface-color); padding: 30px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; border: 1px solid #333; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); color: #000; padding: 10px 20px; border-radius: 30px; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 5000; white-space: nowrap; }
        
        .login-input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: #fff; border-radius: 6px; font-size: 16px; outline: none; }
        .login-input:focus { border-color: var(--primary-color); }
        .auth-btn-primary { background: var(--primary-color); color: #000; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .auth-btn-secondary { background: transparent; color: #999; border: none; font-size: 12px; cursor: pointer; text-decoration: underline; margin-top: 15px; }
        .code-input { width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: #fff; border-radius: 6px; margin-top: 10px; text-align: center; letter-spacing: 2px; }
    </style>
</head>
<body>

    <section id="discovery-view" class="view active">
        <div class="discovery-header">
            <div class="toggle-container">
                <button class="toggle-btn active" id="btn-global" onclick="switchDiscoveryMode('global')">Global</button>
                <button class="toggle-btn" id="btn-mine" onclick="switchDiscoveryMode('mine')">Mine</button>
            </div>
        </div>
        <div class="card-container" id="card-stack"></div>
    </section>

    <section id="ranking-view" class="view">
        <div class="ranking-header">
            <h2 class="font-head" style="margin: 0 0 15px 0;">HALL OF HAHA</h2>
            <div class="filter-group"><button class="filter-btn active" onclick="switchRank('score')">üî• Highest</button><button class="filter-btn" onclick="switchRank('new')">üïí Newest</button></div>
        </div>
        <div class="rank-list" id="rank-list"></div>
    </section>

    <section id="mine-view" class="view" style="overflow-y: auto;">
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <div id="profile-pic" style="width: 60px; height: 60px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; margin-right: 15px; overflow:hidden;">üë§</div>
                <div><h2 id="profile-name" class="font-head" style="margin: 0;">Guest</h2><span id="profile-stats" class="text-sm text-secondary">Login to see stats</span></div>
                <button id="auth-btn" style="margin-left: auto; background: transparent; border: 1px solid #666; color: #fff; padding: 5px 15px; border-radius: 20px;" onclick="toggleAuth()">Login</button>
            </div>
            <h3 class="font-head">MY ARCHIVE</h3>
            <div id="my-works-grid" class="mine-grid"></div>
        </div>
    </section>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('discovery-view', this)"><span>üëÄ</span><span class="nav-label">Discover</span></div>
        <div class="nav-item" onclick="switchTab('ranking-view', this)"><span>üèÜ</span><span class="nav-label">Rank</span></div>
        <div class="nav-item" onclick="openStudio()"><span style="font-size: 32px; font-weight: bold;">‚ûï</span></div>
        <div class="nav-item" onclick="switchTab('mine-view', this)"><span>üë§</span><span class="nav-label">Me</span></div>
    </nav>

    <div id="studio-modal" class="modal">
        <div class="modal-header"><button class="btn-icon" onclick="closeStudio()">‚úï</button><span class="font-head">STUDIO</span><div style="width:24px;"></div></div>
        <div class="studio-body">
            <button class="refresh-btn" id="shuffle-btn" onclick="fetchGiphyTrending(true)"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
            <div class="stage-wrapper" id="stage"><div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div><img id="stage-img" class="stage-bg-img" crossorigin="anonymous"><canvas id="stage-canvas" class="stage-canvas" width="350" height="480"></canvas></div>
            <div class="studio-controls">
                <textarea id="meme-input" placeholder="Enter your funny caption..." oninput="drawMask()"></textarea>
                <div class="action-row">
                    <button class="action-btn btn-normal" onclick="publishMeme(false)">Post Free</button>
                    <div style="flex: 1; display: flex; gap: 8px; position: relative;">
                        <button class="action-btn btn-boost" style="flex:1" onclick="initiateBoost()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg> Boost
                        </button>
                        <button class="help-btn" onclick="toggleBoostHelp()">?</button>
                        <div id="boost-help" class="help-tooltip"><strong>üöÄ Why Boost?</strong><ul class="help-list"><li><b>Forced Exposure:</b> Appears every 5 swipes for everyone.</li><li><b>Gold Border:</b> Stand out with premium styling.</li><li><b>Sponsored Tag:</b> Official partner status.</li></ul></div>
                    </div>
                </div>
                <div class="text-center text-secondary text-sm" style="margin-top:10px; color:#666; text-align:center;">Free Quota: <span id="quota-display">10</span>/10</div>
            </div>
        </div>
    </div>

    <div id="login-modal" class="login-overlay" style="display: none;">
        <div class="login-box">
            <h2 class="font-head" style="margin-bottom: 20px;">WELCOME</h2>
            <div id="login-step-email">
                <p style="color:#888; font-size: 14px; margin-bottom: 20px;">Enter email to login/register</p>
                <input type="email" id="email-input" class="login-input" placeholder="name@example.com">
                <button class="auth-btn-primary" onclick="sendMagicLink()">Get Login Code</button>
            </div>
            <div id="login-step-otp" style="display: none;">
                <p style="color:#888; font-size: 14px; margin-bottom: 20px;">Check your email for the code</p>
                <input type="text" id="otp-input" class="login-input" placeholder="123456" maxlength="6" style="text-align: center; letter-spacing: 4px;">
                <button class="auth-btn-primary" onclick="verifyOtp()">Verify & Login</button>
            </div>
            <button class="auth-btn-secondary" onclick="document.getElementById('login-modal').style.display='none'">Continue as Guest</button>
        </div>
    </div>

    <div id="boost-modal" class="login-overlay" style="display: none;">
        <div class="login-box">
            <h2 class="font-head" style="color: var(--accent-gold);">üöÄ BOOST POST</h2>
            <p style="color:#bbb; font-size: 13px; margin-bottom: 20px;">Get seen by everyone!<br>1. <a href="#" style="color: #fff; font-weight: bold; text-decoration: underline;">Pay $1 here</a><br>2. Enter code from receipt:</p>
            <input type="text" id="boost-code" class="code-input" placeholder="BOOST-XXXX">
            <button class="action-btn btn-boost" style="width:100%; margin-top:15px;" onclick="confirmBoost()">CONFIRM & POST</button>
            <button class="btn-icon" style="margin-top: 15px; font-size: 12px; width: 100%;" onclick="document.getElementById('boost-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div id="toast" class="toast">Action Successful</div>

    <script>
        const SUPABASE_URL = 'https://cezfhqupnllamtefrius.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlemZocXVwbmxsYW10ZWZyaXVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODEwMzIsImV4cCI6MjA4MTU1NzAzMn0.C37o1pas8Uq5tp6xtNUsZhPFZZrst-9tVc217Gdy9Z8';
        const APP_DOMAIN = 'https://haha-5wi3.vercel.app';
        
        const SPONSORED_KEY = 'haha_sponsored_v2';
        const GIPHY_API_KEY = 'MNxTcmXFCMfbOhM6yD1vVDrw4fDHgSbn';
        const BOOST_SECRET = 'BOOST-123'; 
        const AD_FREQUENCY = 5; 

        let supabaseClient = null;
        try {
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch(e) { console.warn("Supabase load failed"); }

        const MEME_KEYWORDS = ['meme', 'funny', 'reaction', 'spongebob', 'laughing'];

        let appState = {
            user: null, db: [], sponsoredDb: [], currentImgUrl: '',
            currentRankFilter: 'score', discoveryMode: 'global', discoveryIndex: 0,
            swipeCounter: 0, quota: { date: new Date().toDateString(), count: 10 }, giphyCache: []
        };

        async function init() {
            if(supabaseClient) {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    appState.user = { email: session.user.email, name: session.user.email.split('@')[0], id: session.user.id };
                }
                const { data, error } = await supabaseClient.from('posts').select('*').order('created_at', { ascending: false }).limit(100);
                if (!error && data) {
                    appState.db = data.map(post => ({
                        id: post.id, user: post.user_name, text: post.text_content, image: post.image_url,
                        likes: post.likes, pass: post.pass_count, timestamp: new Date(post.created_at).getTime(), isAd: post.is_ad
                    }));
                }
            }
            if (appState.db.length === 0) {
                 appState.db = [{ id: 1, user: 'Admin', text: 'Welcome!', image: 'https://media.giphy.com/media/nXxOjZrbnbRxS/giphy.gif', likes: 10, pass: 0, timestamp: Date.now(), isAd: false }];
            }
            const savedAds = localStorage.getItem(SPONSORED_KEY);
            if (savedAds) appState.sponsoredDb = JSON.parse(savedAds);
            else { appState.sponsoredDb = [{ id: 999, user: 'HAHA Official', text: 'Sponsored', image: 'https://media.giphy.com/media/l0Ex6kAKAoFRsFh6M/giphy.gif', likes: 999, pass: 0, timestamp: Date.now(), isAd: true }]; }

            if(appState.discoveryMode === 'global') appState.db.sort(() => 0.5 - Math.random());
            updateUserUI(); renderDiscoveryInit(); renderRanking(); fetchGiphyTrending(false); 
        }

        async function sendMagicLink() {
            const email = document.getElementById('email-input').value.trim();
            if(!email.includes('@')) { showToast("Invalid Email"); return; }
            const { error } = await supabaseClient.auth.signInWithOtp({ email: email, options: { emailRedirectTo: APP_DOMAIN } });
            if (error) { showToast(error.message); } 
            else {
                showToast("Link sent to email!");
                document.getElementById('login-step-email').style.display = 'none';
                document.getElementById('login-step-otp').style.display = 'block';
            }
        }

        async function verifyOtp() {
            const email = document.getElementById('email-input').value.trim();
            const token = document.getElementById('otp-input').value.trim();
            const { data, error } = await supabaseClient.auth.verifyOtp({ email, token, type: 'email'});
            if (error) { showToast("Invalid Code"); } 
            else {
                appState.user = { email: data.user.email, name: data.user.email.split('@')[0], id: data.user.id };
                document.getElementById('login-modal').style.display = 'none';
                updateUserUI(); renderProfile(); showToast("Welcome!");
            }
        }

        async function fetchGiphyTrending(updateStudio = false) {
            if (updateStudio) document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const term = MEME_KEYWORDS[Math.floor(Math.random() * MEME_KEYWORDS.length)];
                const response = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${term}&limit=10`);
                const data = await response.json();
                if (data.data) {
                    appState.giphyCache = data.data.map(gif => gif.images.downsized_medium.url);
                    if (updateStudio) randomizeTemplate();
                }
            } catch (e) { document.getElementById('loading-overlay').style.display = 'none'; } 
        }

        function switchDiscoveryMode(mode) {
            if (mode === 'mine' && !appState.user) { showToast("Login first!"); toggleAuth(); return; }
            appState.discoveryMode = mode;
            document.getElementById('btn-global').classList.toggle('active', mode === 'global');
            document.getElementById('btn-mine').classList.toggle('active', mode === 'mine');
            init();
        }

        function renderDiscoveryInit() {
            const container = document.getElementById('card-stack'); container.innerHTML = '';
            appState.discoveryIndex = 0; appState.swipeCounter = 0;
            if (appState.discoveryMode === 'mine' && !hasUserPosts()) {
                container.innerHTML = `<div class="tinder-card empty-card"><h2 class="font-head">EMPTY</h2><button class="action-btn btn-normal" onclick="openStudio()">Post One</button></div>`;
                return;
            }
            addCardToStack(0); if (getActiveList().length > 1) addCardToStack(1); 
            updateSwipeHandler();
        }

        function getActiveList() {
            return appState.discoveryMode === 'mine' ? appState.db.filter(i => i.user === appState.user.name) : appState.db;
        }

        function hasUserPosts() { return appState.db.some(i => i.user === appState.user.name); }

        function addCardToStack(offsetIndex) {
            const list = getActiveList();
            if (list.length === 0) return;
            let item;
            const effectiveIndex = appState.swipeCounter + offsetIndex;
            if (appState.discoveryMode === 'global' && effectiveIndex > 0 && effectiveIndex % AD_FREQUENCY === 0) {
                item = appState.sponsoredDb[Math.floor(Math.random() * appState.sponsoredDb.length)];
            } else {
                item = list[(appState.discoveryIndex + offsetIndex) % list.length];
            }
            const card = createCardDOM(item);
            document.getElementById('card-stack').appendChild(card);
        }

        function createCardDOM(item) {
            const el = document.createElement('div'); el.className = 'tinder-card'; el.dataset.id = item.id;
            if (item.isAd) el.classList.add('sponsored');
            el.innerHTML = `
                ${item.isAd ? '<div class="sponsored-tag">SPONSORED</div>' : ''}
                <div class="badge badge-haha">HAHA</div><div class="badge badge-pass">PASS</div>
                <div class="meme-layout">
                    <div class="meme-top">${item.text}</div>
                    <div class="meme-middle"><img src="${item.image}" class="meme-img"></div>
                    <div class="meme-footer">
                        <div><span class="font-head">@${item.user}</span><div class="stats-container"><div class="stat-item">H ${item.likes}</div><div class="stat-item">P ${item.pass}</div></div></div>
                        <span class="meme-watermark">HAHA</span>
                    </div>
                </div>`;
            return el;
        }

        async function publishMeme(isBoosted) {
            if (!appState.user && !isBoosted) { document.getElementById('login-modal').style.display = 'flex'; return; }
            const text = document.getElementById('meme-input').value;
            if (!text.trim()) return;
            if (supabaseClient) {
                const { error } = await supabaseClient.from('posts').insert({ user_name: appState.user.name, text_content: text, image_url: appState.currentImgUrl, is_ad: isBoosted });
                if (error) { showToast(error.message); return; }
            }
            closeStudio(); init(); showToast("Posted!");
        }

        function renderProfile() {
            const g = document.getElementById('my-works-grid'); g.innerHTML = '';
            if (!appState.user) return;
            const all = appState.db.filter(i => i.user === appState.user.name).sort((a,b) => b.timestamp - a.timestamp);
            all.forEach(i => { 
                const card = document.createElement('div'); card.className = 'mini-card-wrapper';
                card.innerHTML = `<div class="meme-layout"><div class="meme-top">${i.text}</div><div class="meme-middle"><img src="${i.image}" class="meme-img"></div><div class="meme-footer">@${i.user}<span class="meme-watermark">HAHA</span></div></div>`;
                g.appendChild(card); 
            });
        }
        
        function openStudio() { document.getElementById('studio-modal').classList.add('open'); if(appState.giphyCache.length === 0) fetchGiphyTrending(true); else randomizeTemplate(); }
        function closeStudio() { document.getElementById('studio-modal').classList.remove('open'); }
        function randomizeTemplate() { appState.currentImgUrl = appState.giphyCache[Math.floor(Math.random() * appState.giphyCache.length)]; document.getElementById('stage-img').src = appState.currentImgUrl; drawMask(); }
        function drawMask() {
            const ctx = document.getElementById('stage-canvas').getContext('2d');
            ctx.fillStyle = '#fff'; ctx.fillRect(0,0,350,480);
            ctx.fillStyle = '#000'; ctx.font = 'bold 30px Inter'; ctx.textAlign = 'center';
            ctx.fillText(document.getElementById('meme-input').value, 175, 60);
        }

        function cycleNextCard() { appState.discoveryIndex++; appState.swipeCounter++; addCardToStack(1); updateSwipeHandler(); }
        function updateSwipeHandler() { const c = document.getElementById('card-stack'); if (c.lastElementChild) initSwipe(c.lastElementChild); }
        function initSwipe(card) {
            let startX = 0, isDragging = false;
            const onStart = (e) => { startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; isDragging = true; };
            const onMove = (e) => {
                if(!isDragging) return;
                let cur = (e.type.includes('mouse') ? e.clientX : e.touches[0].clientX) - startX;
                card.style.transform = `translateX(${cur}px) rotate(${cur*0.05}deg)`;
            };
            const onEnd = (e) => {
                isDragging = false; let cur = (e.type.includes('mouse') ? e.clientX : e.changedTouches[0].clientX) - startX;
                if(Math.abs(cur) > 100) {
                    handleInteraction(card.dataset.id, cur > 0 ? 'like' : 'pass', card.classList.contains('sponsored'));
                    card.remove(); cycleNextCard();
                } else card.style.transform = '';
            };
            card.addEventListener('mousedown', onStart); window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onEnd);
            card.addEventListener('touchstart', onStart); card.addEventListener('touchmove', onMove); card.addEventListener('touchend', onEnd);
        }
        
        function handleInteraction(id, type, isAd) { 
            if(!isAd && supabaseClient) supabaseClient.rpc('increment_stats', { row_id: id, action_type: type });
        }
        
        function toggleAuth() { if (appState.user) { supabaseClient.auth.signOut(); appState.user = null; init(); } else document.getElementById('login-modal').style.display = 'flex'; }
        function updateUserUI() { 
            document.getElementById('profile-name').innerText = appState.user ? appState.user.name : 'Guest';
            document.getElementById('auth-btn').innerText = appState.user ? 'Logout' : 'Login';
        }
        function switchTab(viewId, navEl) { 
            document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); 
            document.getElementById(viewId).classList.add('active'); 
            if(viewId==='mine-view') renderProfile();
        }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000); }
        window.onload = init;
    </script>
</body>
</html>
